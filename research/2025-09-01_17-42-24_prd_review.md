---
date: 2025-09-01T17:42:24+0900
researcher: Codex
git_commit: 6293a0ac7c055c53045320d6014f408915a4509b
branch: main
repository: nandseqgen_v2
topic: "PRD 및 CFG 정합성 리뷰"
tags: [research, codebase, PRD, CFG, nandsim_demo, proposer, scheduler]
status: complete
last_updated: 2025-09-01
last_updated_by: Codex
---

# 연구: PRD 및 CFG 정합성 리뷰

**Date**: 2025-09-01T17:42:24+0900
**Researcher**: Codex
**Git Commit**: 6293a0ac7c055c53045320d6014f408915a4509b
**Branch**: main
**Repository**: nandseqgen_v2

## 연구 질문
PRD.md와 config.yaml을 기준으로 nandsim_demo.py 리팩토링 전, 구조적 문제와 (draft) 표기 구간의 모호점을 사전에 식별·정리하고, CFG 스키마/명명·출력 스펙의 불일치 여부를 점검한다.

## 요약
- 스키마/명명 불일치 다수 발견: CSV 필드명, CFG 키(`maxplanes` vs `max_planes`), 상태명/키경로 혼용 등이 존재.
- (draft) 항목의 핵심 의사결정 미정: phase_conditional 자동 채움, 예약 vs 런타임 우선순위, 스냅샷 포맷 등.
- 테스트 관점: 결정적 시드·케이스 정의 부족. 배치 유효성(시퀀스)·락/배제 윈도우·버스 중첩 검증 케이스가 필요.
- 권고: PRD를 기준 스펙으로 고정하고 CFG 빌드 단계에서 매핑/정규화 계층을 명시. CSV 스키마를 고정하고 예시를 일치시킬 것.

## 상세 발견

### 출력 스키마
- operation sequence 예시 불일치: 정의는 `seq,time,op_id,op_name,payload`이나 예시는 `seq,time_op_id,op_name,op_uid,payload` 사용. `time_op_id`, `op_uid` 의미 불명. 권고: `seq,time,op_id,op_name,op_base,source,payload`로 고정 후 예시 수정. refs: `docs/PRD.md:23`, `docs/PRD.md:26` -> (완료) PRD 수정
- address touch count: 필드에 `die/block`가 슬래시로 결합. 권고: `die,block,page` 개별 컬럼으로 분리. refs: `docs/PRD.md:34` -> (완료) PRD 수정. 필드는 분리하고, 시각화 시 die/block 으로 출력
- op_state timeline: 필드에 `op_state`가 중복 기재. 권고: 마지막 항목을 `op_phase`로 개명하거나 제거. refs: `docs/PRD.md:48` -> (완료) 삭제
- payload JSON 이스케이프 일관성 필요. CSV에서 JSON 문자열 인코딩·디코딩 규칙 명시 권장. refs: `docs/PRD.md:26-29` -> (TODO) 논의 필요

### CFG 스키마/명명
- `max_planes`(PRD) vs `maxplanes`(config) 불일치. 하나로 정합화 권고. refs: `docs/PRD.md:77`, `config.yaml:1862` -> (완료) maxplanes 로 통일 완료
- 토폴로지 키 매핑 미정: AddressManager는 `pagesize`를 사용, config는 `pages_per_block`. CFG 빌드 시 `pagesize = topology.pages_per_block` 매핑을 명시. refs: `addrman.py:93`, `config.yaml:7` -> (완료) `addrman.py` 에서 pagesize -> pages_per_block 으로 수정 완료
- PRD의 `CFG['exclusions_by_state']` 표현이 config 키들과 상이. 실제는 `exclusion_groups`와 `exclusions_by_*` 세트. 문서/코드 동일 용어로 정리 필요. refs: `docs/PRD.md:105`, `config.yaml:531`, `config.yaml:1743-1860` -> (완료) PRD 에서 참조하는 값 명확화. exclusion_groups 는 제외할 operation 을 상황별로 group 화 하고, 실제 사용은 exclusions_by_* 의 값을 참조하여 사용 예정
- 철자/오탈자: `duraions`→`durations`, `enf`→`end`, `suspeded_ops`→`suspended_ops`. refs: `docs/PRD.md:86`, `docs/PRD.md:119`, `docs/PRD.md:138` -> (완료) 모두 수정
- op_bases.states 구조: YAML이 리스트(single-key map) 형태. PRD가 `states['STATE']['duration']` 접근을 전제한다면, CFG 빌드에서 리스트→딕셔너리 정규화 단계 명시 필요. refs: `config.yaml:22-35` (TODO) 구체적 설명 필요

### phase_conditional(자동 채움)
- 현재 READ 관련 placeholder만 존재. 기본 정책 정의 필요: 예) (1) 기본 0, 화이트리스트만 가중치 부여, (2) base→op_name 상속 가중치, (3) 학습/프로파일 기반 동적 업데이트. 최소한 SLC/TLC Read, Program/Erase, Cache Read/Program 주요 상태에 대한 초기 분포 시드 필요. refs: `config.yaml:4115-4124`, `docs/PRD.md:82-83, 93`
  -> (TODO) `PRD.md` -> `CFG` -> runtime 으로 만들어야 하는 항목 -> phase_conditional 참조

### Proposer (draft)
- 시간 샘플링 정책: “결정적 시간, 확률적 오퍼레이션”을 명시했으나, 창(window) 정의·충돌 없는 슬롯 탐색·결정성 보장(시드/RNG) 상세 부재. refs: `docs/PRD.md:91-93` -> (TODO) PRD 문서 수정한 내용 토대로 재검토
- 시퀀스 제안 사전검증: 배치 유효성 검사 실패 시 롤백/대안 전환 정책(부분 실행 금지)에 대한 명시 필요. refs: `docs/PRD.md:94-101` -> (TODO) 현재는 제안 실패 시 다음 event 로 넘어가게 돼있으나, 논의 필요

### ResourceManager (draft)
- END 상태 인위 삽입 정책과 suspend/resume 시 재삽입 규칙을 명시했으나, 정확한 상태 전이/복구 절차와 데이터 모델(타임라인 레코드 스키마) 구체화 필요. refs: `docs/PRD.md:118-123` -> (완료) PRD 수정
- 스냅샷/재개: 어떤 타임라인/상태를 어떤 포맷(JSON/CSV)과 파일명 규칙으로 저장·복원하는지 미정. refs: `docs/PRD.md:172-176` -> (TODO) 논의 필요

### Scheduler (draft)
- `event_hook`/`phase_hook` 큐의 메시지 스키마, 우선순위 키, 정렬 기준 정의 필요. 종료 조건과 출력 생성 타이밍도 명시 요망. refs: `docs/PRD.md:168-176` -> (완료) PRD 수정

### Unit Tests (draft)
- 결정적 시드 고정, IO bus 중첩, latch 전이, exclusion windows, suspend→resume 후 타임라인 복구 검증 등 구체 케이스 필요. refs: `docs/PRD.md:181-190` -> (TODO) 논의 필요

## 코드 참조
- `docs/PRD.md:23` — operation sequence 필드 정의와 예시 불일치
- `docs/PRD.md:26` — CSV 예시의 필드명/이스케이프 문제
- `docs/PRD.md:34` — address touch count에서 `die/block` 사용
- `docs/PRD.md:48` — op_state timeline에서 `op_state` 중복
- `docs/PRD.md:82-87` — CFG의 runtime 생성 항목(op_specs, groups_by_base)
- `docs/PRD.md:91-101` — Proposer의 시간/시퀀스 정책 개요
- `docs/PRD.md:118-123` — END 상태 삽입 및 suspend/resume 처리
- `config.yaml:1862` — `maxplanes` 키
- `config.yaml:531` — `exclusion_groups` 루트 정의
- `config.yaml:1743-1860` — `exclusions_by_*` 매핑 집합
- `config.yaml:22-35` — `op_bases.states` 리스트 구조 예시
- `config.yaml:4115-4124` — `phase_conditional` placeholder
- `addrman.py:93` — AddressManager `pagesize` 필요

## 아키텍처 인사이트
- 명세-구현 분리: PRD는 불변 스펙, CFG 빌드는 매핑/정규화 계층으로 스펙과 실제 YAML 구조를 이어준다. 이 계층에서 (키명 정합, states dict화, durations 오버라이드, groups_by_base 생성)을 수행.
- 확률 분포 관리: `phase_conditional`은 기본분포+상태 기반 보정 규칙으로 관리하고, 운영 중 샘플링 성과(거절율/균등성)를 바탕으로 피드백 조정 가능.
- 타임라인 일관성: 모든 예약/실행/종료는 단일 스케줄링 큐에서 이벤트로 표현하고, ResourceManager는 순수 상태 모델과 타임라인 append로 제한해 결합도를 낮춘다.
- 성능 목표(>=2000 seq/s): 규칙/배제 조회는 사전 컴파일(셋/비트마스크/인덱스)하고, 주소 샘플링은 벡터화/캐시로 가속한다.

## 역사적 맥락(thoughts/ 기반)
- 해당 저장소에 thoughts/ 디렉터리가 없어 추가 맥락 없음(현 시점 기준).

## 관련 연구
- 현재 리포 내 별도 research 문서 없음.

## 미해결 질문
- 예약된 operation과 런타임 제안의 우선순위 정책 확정 필요.
  - 대안A(단일 레일·예약 우선): 단순하나 런타임 기회 박탈 위험.
  - 대안B(선점/재검증): 반응성↑, 구현 복잡↑, 진동 위험.
  - 대안C(레일 분리 후 머지): 균형적이나 머지 충돌 해결 규약 필요. refs: `docs/PRD.md:195-199`
- `phase_conditional` 초기 분포 시드 범위(READ 외)와 자동 채움 규칙 정의.
- 스냅샷 파일 포맷/경로/원자성 보장 방식.

